\section{Theoretical Analysis}
\label{sec:analysis}

In this section, the circuit shown in Figure \ref{fig:t2} is analysed
theoretically, in terms of each branch's current and voltage.
The current flows considered in the analysis are the following:
$R_1$ from node 1 to 2; $R_2$ from node 2 to 3; $R_3$ from node 2 to 4; $R_4$ from node 4 to 0; $R_5$ from node 4 to 5; $R_6$ from node 0 to 6; $R_7$ from node 6 to 7. Also, the potencial in Node 0 was considered to be 0V (ground). Node 8 is an auxiliary node which is going to be needed in the simulation.

\subsection{Nodal Analysis for t$<$0}
\label{sec:na}

In this first step, we use Nodal Analysis to determine the voltage in each node as well as the current in every branch of the circuit, when t$<$0. We considered the voltage source $v_s$ to be connected for a long time so the voltages are already constant. Since $i_C$ = $C$$\frac{dv_c}{dt}$ we can assume $i_C$ = 0. \par 
This method is based on Kirchhoff's Current Law (KCL), and firstly consists in
deriving equations for the current flow in nodes not connected to voltage sources,
followed by writing aditional equations in nodes related to voltage sources. The node 
identification can be seen on Figure \ref{fig:t2}. Moreover, the equations relative to
nodes 0, 0, 2, 3 and 5, respectively, are

\begin{equation}
  (V_0 - V_4)/R_4 + (V_0 - V_6)/R_6 + (V_1 - V_2)/R_1 = 0 
  \label{eq:kvl1}
\end{equation}

\begin{equation}
  (V_6 - V_7)/R_7 + (V_0 - V_4)/R_4 + (V_1 - V_2)/R_1 = 0 
  \label{eq:kvl2}
\end{equation}

\begin{equation}
  (V_2 - V_1)/R_1 + (V_2 - V_4)/R_3 + (V_2 - V_3)/R_2 = 0
  \label{eq:kvl3}
\end{equation}

\begin{equation}
  (V_3 - V_2)/R_2 = K_b(V_2 - V_4)
  \label{eq:kvl4}
\end{equation}

\begin{equation}
  (V_4 - V_5)/R_5 = K_b(V_2 - V_4)
  \label{eq:kvl5}
\end{equation}

The aditional equations for the method are

\begin{equation}
  V_4 - V_7 = K_d(V_0 - V_6)/R_6
  \label{eq:kvl6}
\end{equation}

\begin{equation}
  V_0 = 0
  \label{eq:kvl7}
\end{equation}

\begin{equation}
  V_1 = V_s
  \label{eq:kvl8}
\end{equation}


\begin{table}[h]
  \centering
  \begin{tabular}{|l|r|}
    \hline    
    {\bf Name} & {\bf Value [A or V]} \\ \hline
    \input{../mat/Nodal1_tab}
  \end{tabular}
  \caption{Nodal Analysis' variable values for t$<$0, where $I_j$ is expressed in Ampere and $V_j$ is expressed in Volt.}
  \label{tab:Nodal}
\end{table}
\FloatBarrier

\subsection{Equivalent resistance $R_{eq}$}
\label{sec:2.2}

In this step, we use the previously computed values to calculate a voltage defined as $V_x$ = $V_5$ - $V_7$ (voltages in nodes 5 and 7, respectively - which correspond to nodes 6 and 8 from the laboratory paper). Note that this is the voltage drop at the capacitor's terminals, which will be needed for further analysis of the circuit. Firstly, we make $V_S$ = 0. Then, by running nodal analysis again, we can obtain the current $I_x$ flowing through $V_x$. With both these values computed, we can now obtain the value of the equivalent resistance $R_{eq}$ as seen by the capacitor, which is given by $R_{eq}$ = $V_x$/$I_x$. Finally, we can also compute the time constant $\tau$ given by $\tau$ = $R_{eq}$C. We used this procedure because to obtain the equivalent resistor we need to turn off the independent sources and due to the presence of dependent sources we replaced the capacitor with a independent voltage source with value $V_x$ to ensure the continuity of the capacitor's voltage function. \par   
Also, this corresponds to the initial calculations for computing the natural solution. \par
Defining $V_x$ = $V_5$ - $V_7$ makes sense because the voltage drop in the capacitor is a continuous function, so $V_x$(t=$0^-$) = $V_x$(t=0).
We considered the equations \ref{eq:kvl1}, \ref{eq:kvl2}, \ref{eq:kvl3}, \ref{eq:kvl4}, \ref{eq:kvl6}, \ref{eq:kvl7}, \ref{eq:kvl8} and the following two:

\begin{equation}
  V_5 - V_7 = V_x
  \label{eq:kvl9}
\end{equation}

\begin{equation}
 I_X = (V_4 - V_5)/R_5 - K_b(V_2 - V_4) 
  \label{eq:kvl10}
\end{equation}


\begin{table}[h]
  \centering
  \begin{tabular}{|l|r|}
    \hline    
    {\bf Name} & {\bf Value [A or V or $\Omega$ or s]} \\ \hline
    \input{../mat/Req_tau_tab}
  \end{tabular}
  \caption{Equivalent resistance $R_{eq}$ and time constant $\tau$}
  \label{tab:Req}
\end{table}
\FloatBarrier

\subsection{Natural Solution}

Now, using the previous results we can compute the natural solution $v_{5n}$(t) from 0 to 20ms in time, as requested. We know that the solution is of the general form 
\begin{equation}
Ae^{-t/\tau}.
\label{eq:kvl11}
\end{equation}

Now, we only need an initial condition to find the constant "A" which is going to be the value of $V_x$, the capacitor's voltage for t$\leq$0. A plot of the solution in t$\in$[0;20]ms is shown in \ref{fig:v5_n}. Analysing the parameters of the circuit for t=0 we note that $V_7$ = 0V and $V_c$ decreases, which leads to

\begin{equation}
  V_5 = V_c = V_xe^{-t/\tau} 
  \label{eq:kvl12}
\end{equation}


\begin{figure}[h] \centering
\includegraphics[width=0.6\linewidth]{v5_n.eps}
\caption{Natural solution for $v_5$}
\label{fig:v5_n}
\end{figure}
\FloatBarrier

\subsection{Forced solution}

In this step, we use a phasor voltage source $V_S$ and replace the capacitor with its impedance $Z_C$. Then we use the nodal method again in order to determine the phasor voltages in every node, and register the data in \ref{tab:Phasors}. \par
The goal is to obtain the forced solution $v_{5f}$(t) in t$\in$[0;20]ms for a frequency f = 1kHz. \par
The nodal analysis is equivalent to the previous ones in terms of equations, but instead of voltages we use phasors:

%Aqui aplicou-se o método dos nós, mas temos phasors, portanto repetirei todas as eqs mas assinalo as que ficam diferentes caso queiram tirar as que estão a mais

\begin{equation}
  (\tilde{V}_2 - \tilde{V}_1)/R_1 + (\tilde{V}_2 - \tilde{V}_4)/R_3 + (\tilde{V}_2 - \tilde{V}_3)/R_2 = 0
  \label{eq:4_13}
\end{equation}

\begin{equation}
 (\tilde{V}_0 - \tilde{V}_4)/R_4 + (\tilde{V}_0 - \tilde{V}_6)/R_6 + (\tilde{V}_1 - \tilde{V}_2)/R_1 = 0 
  \label{eq:4_14}
\end{equation}

\begin{equation}
  (\tilde{V}_6 - \tilde{V}_7)/R_7 + (\tilde{V}_0 - \tilde{V}_4)/R_4 + (\tilde{V}_1 - \tilde{V}_2)/R_1 = 0 
  \label{eq:4_15}
\end{equation}

\begin{equation}
  (\tilde{V}_3 - \tilde{V}_2)/R_2 = K_b(\tilde{V}_2 - \tilde{V}_4)
  \label{eq:4_16}
\end{equation}

\begin{equation}
  (\tilde{V}_5 - \tilde{V}_7)/Z_C + (\tilde{V}_5 - \tilde{V}_4)/R_5 + K_b(\tilde{V}_2 - \tilde{V}_4) = 0, Z_C = 1/(jwC)
  \label{eq:4_17}
\end{equation}

\begin{equation}
  \tilde{V}_4 - \tilde{V}_7 = K_d(\tilde{V}_0 - \tilde{V}_6)/R_6
  \label{eq:kvl18}
\end{equation}

\begin{equation}
  \tilde{V}_1 = \tilde{V}_s
  \label{eq:kvl19}
\end{equation}


\begin{figure}[h] \centering
\includegraphics[width=0.6\linewidth]{v5_f.eps}
\caption{Forced Solution for $v_5$}
\label{fig:v5_f}
\end{figure}
\FloatBarrier


\begin{table}[h]
  \centering
  \begin{tabular}{|l|r|}
    \hline    
    {\bf Name} & {\bf Value [V]} \\ \hline
    \input{../mat/phasors_tab}
  \end{tabular}
  \caption{Complex amplitudes in the nodes}
  \label{tab:Phasors}
\end{table}
\FloatBarrier



\subsection{Final solution}

Now we are able to describe the final solution $v_5$(t) after converting the forced solution to a real time function. The solution is the sum of the contributions of the natural and forced responses of the circuit:  

\begin{equation}
  v_5 = v_{5f} + v_{5n}
  \label{eq:kvl20}
\end{equation}

The following plot displays $v_5$(t) and $v_s$(t) for t$\in$[-5;20]ms. The values of t$<$0 were obtained in \ref{sec:na}.

\begin{figure}[h] \centering
\includegraphics[width=0.6\linewidth]{v5_vs.eps}
\caption{Final Solution for $v_5$ and $v_s$}
\label{fig:v5_vs}
\end{figure}
\FloatBarrier

\subsection{Frequency response}
\label{sec:frequency}

In this final step we use the functions $v_5$(f) and $v_7$(f) (voltages on nodes 5 and 7, respectively, in terms of frequency, f) using a logarithmic scale for frequency (dB) and expressing the phase in degrees, with f$\in$[0.1;1]kHz. \par
Defining $v_C$(f) = $v_5$(f) - $v_7$(f), we can then plot different functions $v_S$(f), $v_C$(f) and $v_6$(f) as seen in \ref{fig:freqresp} (amplitude) and in \ref{fig:phase_oct} (phase, in degrees).

%EXPLICAR AS DIFERENÇAS

\begin{figure}[h] \centering
\includegraphics[width=0.6\linewidth]{freqresp.eps}
\caption{Magnitude in dB $v_5$(f) (red), $v_s$(f) (blue), $v_c$(f) (green)}
\label{fig:freqresp}
\end{figure}
\FloatBarrier

\begin{figure}[h] \centering
\includegraphics[width=0.6\linewidth]{phase_oct.eps}
\caption{Phase in degrees $v_5$(f) (red), $v_s$(f) (blue), $v_c$(f) (green)}
\label{fig:phase_oct}
\end{figure}
\FloatBarrier

Firstly we can analyze the behavior of $v_s$(f) and verify that both in terms of magnitude and phase, a constant value is presented regardless of the frequency. This is due to the fact that $v_s$(f) is defined as $v_s$ = sin($2$.$\pi$.$f$.$t$), where we can see that neither the magnitude nor the phase depend on frequency.
Analyzing $v_c$ it can be seen that it behaves as a low pass filter, because for low frequencies the capacitor has time to charge up while for high frequencies the difference between $v_7$ and $v_5$ decreases, since the capacitor no longer has time to charge up functioning as a short circuit. These changes on high frequencies start to occur when the cutoff frequency ($f_c = \frac{1}{2.\pi.\tau}$)is exceeded and it turns out that the transition period is between two decades as expected. In this case we have a cutoff frequency around 50 Hz and the transition is between the first and third decades. 
Simplifying the circuit to an independent voltage source, an equivalent resistor and a capacitor in series we can obtain two equations, (\ref{eq:freqresp1} and \ref{eq:freqresp2}), and it is possible to see that for low frequencies $v_c$=$v_s$ and phase = -$\frac{\pi}{2}$, and for high frequencies $v_c$=$0$ and phase = $-\pi$.
Finally the changes presented in $v_s$(f) and in $v_5$(f) are due to the presence of the impedance of the capacitor in the calculations and this fact makes these variables depend on the frequency. 

\begin{equation}
  V_c = \frac{V_s}{\sqrt{1 + (R_{eq}.C.2\pi.f)^2}}
  \label{eq:freqresp1}
\end{equation}

\begin{equation}
  \phi_{V_c} = -\frac{\pi}{2} - arctan(R_{eq}.C.2\pi.f)
  \label{eq:freqresp2}
\end{equation}















